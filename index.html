<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Cantus - MEI Editor</title>

        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//cantus.simssa.ca/static/css/cantus.min.css">
        <link rel="stylesheet" href="diva.js/build/css/diva.min.css" />
        <link rel="stylesheet" href="meix.js/css/meiEditor.css" />
        <link rel="stylesheet" href="meix.js/css/zoneDisplay.css" />
        <link rel="stylesheet" href="divaEditor.css" />
        <link rel="Shortcut Icon" href="/favicon.ico">

        <!--foreign libraries -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <!--local libraries -->
        <!-- <script src="diva.js/build/js/diva.js" type="text/javascript"></script>
        <script src="diva.js/build/js/utils.js" type="text/javascript"></script>
        <script src="diva.js/build/js/plugins/highlight.js" type="text/javascript"></script>
        <script src="diva.js/build/js/plugins/highlight.js" type="text/javascript"></script> -->
        <script src="diva.js/build/js/diva.min.js" type="text/javascript"></script>

        <script src="meix.js/js/lib/require.js"></script>
        <script src="meix.js/js/local/meiEditorPreloader.js"></script>
    </head>
    <body>
        <div id="mei-editor"></div>
        <div id="diva-wrapper"></div>
        <div id="loadingScreen">
            <h2 id="loadingHeader">Please wait...</h2>
            <select id='manuscriptSelect'></select><br>
            <p id="manuscriptDescription"></p>
            <button id='manuscriptSubmit'>Load</button>
        </div>
    </body>
    <script>
        var manuscripts = {
            'CSG-0390-ID': {
                name: 'CSG-0390',
                description: 'The manuscript we use for demonstration',
                meiId: 'csg-0390',
                meiSource: 'local',
                iiifId: 'csg-0390',
                iiifSource: 'e-codices'
            },
            'CSG-0389-ID': {
                name: 'CSG-0390',
                description: "A simulated entry with the exact same manuscript <br/>" +
                             "because we are lazy but we still need to test this",
                meiId: 'csg-0390',
                meiSource: 'local',
                iiifId: 'csg-0390',                
                iiifSource: 'e-codices'
            }
        }
        var meiSources = {
            'local': {
                name: 'Local folder',
                description: 'Files stored within the CantusEditor',
                baseURL: document.URL,
                getMeiURL: function(meiId) {
                    return this.baseURL + "resources/mei/" + meiId + "/";
                }
            }      
        }
        var iiifSources = {
            'e-codices': {
                name: 'e-codices',
                description: 'Library of manuscripts',
                baseURL: 'https://www.e-codices.unifr.ch/',
                getManifestURL: function(iiifId) {
                    return this.baseURL + 'metadata/iiif/' + iiifId + '/manifest.json';
                }
            }
        }
        var productionURL = "https://ddmal.github.io/CantusEditor/";
        var isProduction = document.URL === productionURL ? true : false;                
        var manuscriptList = Object.keys(manuscripts);
        var meiEditor;
        var divaInstance;
	    var element;
        var selectedManuscript = null;
        if(!isProduction) {
            console.log("Development environment detected.");
        }  

        function getLinks(htmlCode, hasSubstr="") {
            var lines = htmlCode.split("\n");
            var links = [];
            lines.forEach(function(line) {
                // Ignore empty lines
                if(!line) {
                    return;
                }
                var link = line.match(/<a href=".*">/g);
                if(link) {
                    linkText = link[0].slice(9, -2);
                    if(!hasSubstr || (hasSubstr && linkText.match(hasSubstr))) {
                        links.push(linkText);
                    }
                }
            });
            return links;
        }

        manuscriptList.forEach(function(manuscriptId) {
            var manuscript = manuscripts[manuscriptId];
            $("#manuscriptSelect").append("<option disabled id='manuscript_" +
              manuscriptId + "' value='" + manuscriptId + "'>" + 
              manuscript.name + "</option>");
            manuscript.id = manuscriptId;
            findMeiFolders(manuscript);
        })

        $("#manuscriptSelect").change(function() {
            manuscriptId = $("#manuscriptSelect option:selected").attr('value');
            selectedManuscript = manuscripts[manuscriptId];
            $('#manuscriptDescription').html(selectedManuscript.description);
        })

        $(document).ajaxStop(function() {
            $('#loadingHeader').html("Choose a manuscript to load:");
        });

        function findMeiFolders(manuscript) {
            var meiSource = meiSources[manuscript.meiSource];
            $.ajax({
                url: meiSource.getMeiURL(manuscript.meiId),
                success: function(e) {
                    manuscript.meiFiles = getLinks(e, ".mei");
                    findIIIFManifest(manuscript);
                },
                error: function(e) {
                    if(!isProduction) {
                        console.log('>>> No ".mei" files found for' +
                                    ' manuscript ' + manuscript.name);
                    }
                }
            });
        }

        function findIIIFManifest(manuscript) {
            var iiifSource = iiifSources[manuscript.iiifSource];
            $.ajax({
                url: iiifSource.getManifestURL(manuscript.iiifId),
                type: "HEAD",                
                success: function(e) {
                    $('#manuscript_' + manuscript.id).attr('disabled', false);
                },
                error: function(e) {
                    if(!isProduction) {
                        console.log(">>> No IIIF Manifest found in " +
                                    iiifSource.name + " for manuscript " +
                                    manuscript.name);
                    }
                }
            });
        }

        $("#manuscriptSubmit").click(function() {
            if(selectedManuscript) {
                editorInit(selectedManuscript);
            }
        });

        function editorInit()
        {
            var pageAliases;
            var pageAliasFunction;
            var newTotal;
            var meiSourceRef = meiSources[selectedManuscript.meiSource];
            var iiifSourceRef = iiifSources[selectedManuscript.iiifSource];
            var manifestURL = iiifSourceRef.getManifestURL(selectedManuscript.iiifId);
            var meiURL = meiSourceRef.getMeiURL(selectedManuscript.meiId);
            $("#loadingScreen").html("The Cantus MEI Editor is loading...");

            $('#diva-wrapper').diva({
                        fixedHeightGrid: true,
                        objectData: manifestURL,
                        enableIIIFMetadata: true,
                        enableHighlight: true
            });

            divaInstance = $('#diva-wrapper').data('diva');

            element = "#mei-editor";
            var options = 
            {
                'meiEditorLocation': 'meix.js/',
                'validatorLink': 'meix.js/validation/', 
                'xmllintLocation': 'meix.js/js/lib/xmllint.js',
                'divaInstance': divaInstance, 
                'oneToOneMEI': true,
                'navbarClass': 'navbar navbar-default',
                'pageTitle': 'Cantus Ultimus',
                'initializeWithFile': 'csg-0390_007.mei',
                'disableMultiPage': true
            };

            var plugins = ["meix.js/js/local/plugins/meiEditorZoneDisplay.js"];

            meiEditor = new MeiEditor(element, options, plugins);
        } 

        $(window).on('meiEditorLoaded', function(e){
            var meiSourceRef = meiSources[selectedManuscript.meiSource];
            var iiifSourceRef = iiifSources[selectedManuscript.iiifSource];
            var manifestURL = iiifSourceRef.getManifestURL(selectedManuscript.iiifId);
            var meiURL = meiSourceRef.getMeiURL(selectedManuscript.meiId);
            
            meiEditor = $("#mei-editor").data('AceMeiEditor');
            $(".diva-tools").addClass('diva-toolbar navbar navbar-default');
            $("#loadingScreen").animate({
                'height': '30px',
                'line-height': '30px',
                'opacity': '0'
            }, {
                duration: 300,
                complete: function(){$("#loadingScreen").remove();}
            });

            $("#dropdown-file-upload").append("<li><a id='server-load-dropdown'>Load file from server...</a></li>"); 

            $("#server-load-dropdown").on('click', function(e){
                $("#serverLoadModal").modal();
            });

            var foreignPageNames = selectedManuscript.meiFiles;

            createModal(element, "serverLoadModal", false,
                "Select a hosted file:<br>" +
                createSelect("hosted-file", foreignPageNames, true),
                "Load");

            $("#serverLoadModal-primary").on('click', function() {
                var pageName = $("#selecthosted-file").find(':selected').text();                
                $.get(meiURL + pageName, "", function(data) {
                    meiEditor.addFileToProject(data, pageName);
                });
                $("#serverLoadModal-close").trigger('click');
            });        

            $("#dropdown-zone-display").append("<li><a><label class='checkbox'>Auto-load: </span><input type='checkbox' id='auto-load-checkbox'  style='float:right;' checked/></label></a></li>");

            diva.Events.subscribe("VisiblePageDidChange", function(pageNumber, fileName) {
                if (!$("#auto-load-checkbox").prop('checked')) return;
                fileName = fileName.split('/');
                fileName = fileName[fileName.length -1];
                if (foreignPageNames.indexOf((fileName.split(".")[0] + ".mei")) > -1) {
                    var meiPage = fileName.split(".")[0] + ".mei";
                    if (meiEditor.getPageTitles().indexOf(meiPage) >= 0) return;
                    $.get(meiURL + meiPage, "", function(data) {
                        meiEditor.addFileWithoutJumping(data, meiPage);
                    });
                }
            });

            meiEditor.events.subscribe("NewZone", function(pageRef, prevID, nextID, curID)
            {
                var toInsert = pageRef.parsed.createElement('neume');
                toInsert.setAttribute('xml:id', genUUID());
                toInsert.setAttribute('name', "Unnamed");
                toInsert.setAttribute('facs', curID);

                var prevIdx, prevNeume, nextIdx, nextNeume;
                if(nextID)
                {
                    nextNeume = pageRef.parsed.querySelectorAll('neume[*|facs=' + nextID + ']')[0];
                    nextIdx = Array.prototype.indexOf.call(nextNeume.parentElement.childNodes, nextNeume);
                }

                if(prevID)
                {
                    prevNeume = pageRef.parsed.querySelectorAll('neume[*|facs=' + prevID + ']')[0];
                    prevIdx = Array.prototype.indexOf.call(prevNeume.parentElement.childNodes, prevNeume);
                }

                if (nextIdx && prevIdx && (Math.abs(nextIdx - prevIdx) > 2))
                {
                    meiEditor.localWarn('Tried to insert a neume between two that were not adjacent.');
                }        

                if (nextID)
                {
                    indentNode = nextNeume.parentElement.childNodes[nextIdx - 1].cloneNode(false);

                    nextNeume.parentElement.insertBefore(toInsert, nextNeume);
                    nextNeume.parentElement.insertBefore(indentNode, nextNeume);
                }

                else
                {
                    indentNode = prevNeume.parentElement.childNodes[prevIdx - 1].cloneNode(false);

                    inserted = prevNeume.insertAdjacentElement("afterEnd", toInsert);
                    inserted.parentElement.insertBefore(indentNode, inserted);
                }

                rewriteAce(pageRef);

                var newZoneHandler = meiEditor.events.subscribe('ZonesWereUpdated', function()
                {
                    meiEditor.selectHighlight("#" + curID);
                    meiEditor.events.unsubscribe(newZoneHandler);
                });


            });
        });
    </script>
</html> 
